---
title: "An치lisis exploratorio"
author: "Majo Gil"
format: html
editor: visual
---

# Hoja de trabajo 3

```{r include=FALSE}

library(dplyr)
library(ggplot2)
library(reshape2)
library(psych)
library(corrplot)
library(RColorBrewer)
library(nortest)
library(lmtest)

pricesTrain <- read.csv("train.csv")
```

## An치lisis Exploratorio

```{r}

View(pricesTrain)
nrow(pricesTrain) 
ncol(pricesTrain) 
str(pricesTrain)
```

### Variables Categ칩ricas:

-   Id

-   MSSubClass

-   MSZoning

-   Street

-   Alley

-   LotShape

-   LandContour

-   Utilities

-   LotConfig

-   LandSlope

-   Neighborhood

-   Condition 1

-   Condition 2

-   BldgType

-   HouseStyle

-   OverallQual

-   OverallCond

-   RoofStyle

-   RoofMatl

-   Exterior1st

-   Exterior2nd

-   MasVnrType

-   ExterQual

-   ExterCond

-   Foundation

-   BsmtQual

-   BsmtCond

-   BsmtExposure

-   BsmtFinType1

-   BsmtFinSF1

-   BsmtFinType2

-   Heating

-   HeatingQC

-   CentralAir

-   Electrical

-   Functional

-   FireplaceQu

-   GarageType

-   GarageFinish

-   GarageQual

-   GarageCcond

-   PavedDrive

-   PoolQC

-   Fence

-   MiscFeature

-   SaleType

-   SaleCondition

### Variables Cuantitativas

-   LotFrontage

-   LotArea

-   YearBuilt

-   YearRemodAdd

-   MasVnrArea

-   BsmtFinSF1

-   BsmtFinSF2

-   BsmtUnfSF

-   TotalBsmtSF

-   1stFlrSF

-   2ndFlrSF

-   LowQualFinSF

-   GrLivArea

-   BsmtFullBath

-   BsmtHalfBath

-   FullBath

-   HalfBath

-   Bedroom

-   Kitchen

-   TotRmsAbvGrd

-   Fireplaces

-   FireplaceQu

-   GarafeYrBlt

-   GarageCars

-   GarageArea

-   WoodDeckSF

-   OpenPorchSF

-   EnclosedPorch

-   3SsnPorch

-   ScreenPorch

-   PoolArea

-   MiscVal

-   MoSold

-   YrSold

### Eliminaci칩n de variables

A continuaci칩n se eliminar치n las variables que se consideran innecesarias para el modelo

#### Gr치fica de correlaci칩n de las variables

```{r}
# Graficar cada variable
#set.seed(100)
# Eliminar cualitativas
pricesTrainGraph <- pricesTrain %>% select(-c(Id,MSSubClass, MSZoning, Street, Alley, LotShape, LandContour, Utilities, LotConfig, LandSlope, Neighborhood, Condition1, Condition2, BldgType, HouseStyle, OverallQual, OverallCond, RoofStyle, RoofMatl, Exterior1st, Exterior2nd, MasVnrType, ExterQual, ExterCond, Foundation, BsmtQual, BsmtCond, BsmtExposure, BsmtFinType1, BsmtFinSF1, BsmtFinType2, Heating, HeatingQC, CentralAir, Electrical, Functional, FireplaceQu, GarageType, GarageFinish, GarageQual, GarageCond, PavedDrive, PoolQC, Fence, MiscFeature, SaleType, SaleCondition, KitchenQual))

# pairs(pricesTrainGraph)
# plot(pricesTrainGraph)

corPlot(pricesTrainGraph) # Correlaci칩n de todas las variables num칠ricas


cor(pricesTrainGraph[ , colnames(pricesTrainGraph) != "SalePrice"], pricesTrainGraph$SalePrice)


mcor <- cor(x = pricesTrainGraph$SalePrice, y = pricesTrainGraph[0:32], use="complete.obs")
corrplot(mcor,method = 'shade',tl.cex = 1,
         col = COL2('PRGn'), diag = FALSE)
# pricesTrainGraph <- melt (pricesTrainGraph, id.vars = 'SalePrice', variable.name = 'Feature')



```

De este modo podemos ver que las variables BsmtFinSF2, LowQualFinSF, BsmtHalfBath, , GarageYrBlt, X3SsnPorch, MiscVal no tienen nig칰n tipo de correlaci칩n y podr칤an afectar de manera negativa en el modelo, de modo que se eliminar치n as칤 como la mayor칤a de variables cualitativas. En total se eliminar치n las siguientes variables : *Id, MSSubClass, Street, Alley, LotShape, LandContour, LotConfig, LandSlope, Neighborhood, Condition1, Condition2, BldgType, RoofStyle, RoofMatl, Exterior1st, Exterior2nd, MasVnrType, BsmtQual, BsmtCond, BsmtExposure, BsmtFinType1, BsmtFinType2, Heating, Electrical, KitchenQual, FireplaceQu, GarageFinish, GarageQual, PavedDrive, PoolQC, Fence, MiscFeature, SaleType, SaleCondition, BsmtFinSF2, LowQualFinSF, BsmtHalfBath, , GarageYrBlt, X3SsnPorch, MiscVal*

#### Eliminaci칩n de variables

```{r}

# Remove columns using select()
pricesTrainDel <- pricesTrain %>% select(-c(Id, MSSubClass, Street, Alley, LotShape, LandContour, LotConfig, LandSlope, Neighborhood, Condition1, Condition2, BldgType, RoofStyle, RoofMatl, Exterior1st, Exterior2nd, MasVnrType, BsmtQual, BsmtCond, BsmtExposure, BsmtFinType1, BsmtFinType2, Heating, Electrical, KitchenQual, FireplaceQu, GarageFinish, GarageQual, PavedDrive, PoolQC, Fence, MiscFeature, SaleType, SaleCondition, BsmtFinSF2, LowQualFinSF, BsmtHalfBath, KitchenAbvGr, GarageYrBlt, EnclosedPorch, MiscVal))


## Ver df nuevo

## Volver variables chr a int
## pricesTrainDel %>%
##  mutate(
#    MSZoning = factor(MSZoning, levels = c('RM', 'RP', 'RL', 'RH', 'I', 'FV', 'C', 'A'), labels = c(0,1,2,3,4,5,6,7)), 
#    Utilities = factor(Utilities, levels = c('ELO','NoSeWa', 'NoSewr', 'AllPub'), labels = c(0,1,2,3)), 
#    HouseStyle = factor(HouseStyle, levels = c('SLvl', 'SFoyer', '2.5Unf', '2.5Fin', '2Story', '1.5Unf', '1.5Fin', '1Story'), labels = c(0,1,2,3,4,5,6,7)))
#  mutate(MSZoning = recode(MSZoning, 'RM' = 0, 'RP' = 1, 'RL' = 2, 'RH' = 3, 'I' = 4, 'FV' = 5, 'C' = 6, 'A' = 7), Utilities = recode(Utilities, 'ELO' = 0, 'NoSeWa' = 1, 'NoSewr' = 2, 'AllPub' = 3), HouseStyle = recode(HouseStyle, 'SLv1' = 0, 'SFoyer' = 1))


str(pricesTrainDel)
```

## Regresiones

```{r muestreo}
set.seed(123)
p <- 0.7
corte <- sample(nrow(pricesTrain), nrow(pricesTrain) * p)
train <- pricesTrain[corte,]
test <- pricesTrain[-corte,]
<<<<<<< Updated upstream

modelo <- lm(formula = `SalePrice`~`GrLivArea`, data = train)
summary(modelo)
```

\## VALIDACI흁 DEL MODELO

\### Significancia global

Ho: \\beta\_{costos}=0\$\$

\$\$Ha: \\text{Alguno de los coeficientes es diferente de cero}\$\$

En la tabla anterior se puede observar que la prueba F produce un \$valor-p = 2.2\\times10\^{-16}\$ lo cual indica que el modelo tiene una significancia global.

\### Significancia parcial

\$\$Ho: \\beta\_{\\text{costo}}=0\$\$

\$\$Ha: \\beta\_{\\text{costo}}\\neq 0\$\$

Con un \$valor-p = 2.2\\times10\^{-16}\$ podemos afirmar que el coeficiente del costo asociado a las ventas, es diferente de cero, por lo que la variable "costo", es significativa en el modelo generado.

\## COEFICIENDE DE DETERMINACI흁:

El coeficiete de determinaci蚤 del modelo es \$r\^2 = 0.4877\$, lo cual indica que el 48.7% de la variabilidad del fen藻eno esta siendo explicado por el modelo generado.

El \$r\^2\$ ajustado se encuentra bastante cercado al coeficiente de determinaci蚤, por lo que la colinealidad no es un problema que nos deba preocupar.

\## AN첿ISIS DE RESIDUALES

\### Normalidad (Prueba de lillie)

\$\$Ho: \\text{Normalidad en los residuales}\$\$

\$\$Ha: \\text{No hay normalidad en los residuales}\$\$

```{r}
library(nortest)
lillie.test(modelo$residuals)
```

El test anterior nos brinda un \$valor-p =2.2\\times10\^{-16} \< 0.05\$, por lo que tenemos evidencia suficiente para rechazar la hip遭esis nula, y con una significancia de 0.05, los residuales no tienen un comportamiento normal. Por lo que no se podria recomendar la utilizaci蚤 del modelo generado.

\### VARIANZA CONSTANTE (Homocedasticidad)

Utilizaremos la prueba de Breusch Pagan.

\$\$Ho: \\text{homocedasticidad}\$\$

\$\$ Ha: \\text{no homocedasticidad}\$\$

```{r, message=FALSE, warning=FALSE}
library(lmtest)

bptest(modelo)
```

Con un \$valor-p= 2.2\\times10\^{-16}\<0.05\$, existe evidencia de falta de homocedasticidad, por lo que podemos suponer que la varianza de los resiudales no es constante.

\## Independencia de los residuos

Utilizaremos la prueba de Durbin Watson, la cual mide la autocorrelaci蚤 entre los residuales.

\$\$Ho: \\text{Los residuos estan autocorrelacionados}\$\$

\$\$Ha: \\text{No existe autocorrelaci蚤 en los residuales}\$\$

```{r}
dwtest(modelo)
```

El \$valor-p=9854 \>0.05\$ indica que los residuales est烱 autocorrelacionados, por lo que podemos afirmar que los residuales no son independientes. por lo cual no es recomendado utilizar el modelo

```{r}
t.test(modelo$residuals)
```

\$\$Ho: \\mu\_{residuales}=0\$\$

\$\$Ha: \\mu\_{residuales}\\neq 0\$\$

Con un \$valor-p = 1\$ no hay evidencia para rechazar la hip遭esis nula, por lo que parece razonable afirmar que la media de los residuales es igual a cero.

\## CONCLUSI흁 GENERAL

El modelo generado es:

\$\\hat y = 22245.586+3.221x_1\$

donde:

\$\$x_1 = \\text{area de la casa}\$\$

aunque no es recomendado utilizarlo por la dependencia de los residuos y falta de normalidad

```{r}
a<-predict(modelo,newdata=data.frame(GrLivArea=test$GrLivArea))
b<-mean(a-test$GrLivArea)
plot(test$GrLivArea,a,col="green")
par(new=TRUE)
plot(test$GrLivArea,test$SalePrice,col="blue")
=======
test['YearsBuilt'] = 2023 - test$YearBuilt
test['YearsRem'] = 2023 - test$YearRemodAdd
>>>>>>> Stashed changes
```

### Regresi칩n lineal multivariable

#### Preprocesamiento de datos

```{r multivariable}
str(train)
numericasTrain <- train[, c('MSSubClass', 'LotArea', 'OverallQual', 'OverallCond', 'YearsBuilt', 'YearsRem', 'BsmtFinSF1', 'BsmtFinSF2', 'BsmtUnfSF', 'TotalBsmtSF', 'X1stFlrSF', 'X2ndFlrSF', 'LowQualFinSF', 'GrLivArea', 'BsmtFullBath', 'BsmtHalfBath', 'FullBath', 'HalfBath', 'BedroomAbvGr', 'KitchenAbvGr', 'TotRmsAbvGrd', 'Fireplaces', 'GarageCars', 'GarageArea', 'WoodDeckSF', 'OpenPorchSF', 'EnclosedPorch', 'X3SsnPorch', 'ScreenPorch', 'PoolArea', 'MiscVal', 'MoSold', 'SalePrice')]
numericasTest <- test[, c('MSSubClass', 'LotArea', 'OverallQual', 'OverallCond', 'YearsBuilt', 'YearsRem', 'BsmtFinSF1', 'BsmtFinSF2', 'BsmtUnfSF', 'TotalBsmtSF', 'X1stFlrSF', 'X2ndFlrSF', 'LowQualFinSF', 'GrLivArea', 'BsmtFullBath', 'BsmtHalfBath', 'FullBath', 'HalfBath', 'BedroomAbvGr', 'KitchenAbvGr', 'TotRmsAbvGrd', 'Fireplaces', 'GarageCars', 'GarageArea', 'WoodDeckSF', 'OpenPorchSF', 'EnclosedPorch', 'X3SsnPorch', 'ScreenPorch', 'PoolArea', 'MiscVal', 'MoSold', 'SalePrice'
```

#### Correlaci칩n de las variables

```{r correlacion}
matriz_cor = cor(numericasTrain, method = 'spearman')
corrplot(matriz_cor, type = 'upper')

newNumericasTrain <- train[, c('MSSubClass', 'LotArea', 'OverallQual', 'OverallCond', 'BsmtFinSF1', 'BsmtFinSF2', 'TotalBsmtSF', 'LowQualFinSF', 'BsmtHalfBath', 'HalfBath', 'KitchenAbvGr', 'TotRmsAbvGrd', 'Fireplaces', 'WoodDeckSF', 'OpenPorchSF', 'EnclosedPorch', 'X3SsnPorch', 'ScreenPorch', 'PoolArea', 'MiscVal', 'MoSold', 'SalePrice')]
```

Dada la correlaci칩n entre las variables evidenciada en la gr치fica, es necesario prescindir de las variables YearsBuilt, YearsRem, GrLivArea, FullBath, GarageCars, GarageArea, BsmtUnfSF, BsmtFullBath, X1stFlrSF, X2ndFlrSF, BedroomAbvGr.

#### Generando el modelo

```{r modelo}
mdLnlMtv <- lm(SalePrice~., data = newNumericasTrain)
summary(mdLnlMtv)
step(mdLnlMtv)
```

De la funci칩n anterior tenemos que el mejor modelo es el de la forma

    SalePrice ~ MSSubClass + LotArea + OverallQual + BsmtFinSF1 + 
        BsmtFinSF2 + TotalBsmtSF + LowQualFinSF + HalfBath + KitchenAbvGr + 
        TotRmsAbvGrd + Fireplaces + WoodDeckSF + OpenPorchSF + EnclosedPorch + 
        X3SsnPorch + ScreenPorch + PoolArea + MoSold

Por lo tanto. Consideremos ese modelo de ahora en adelante

#### Generando el mejor modelo

```{r mejorModelo}
mejorModelo <- lm(SalePrice ~ MSSubClass + LotArea + OverallQual + BsmtFinSF1 + 
    BsmtFinSF2 + TotalBsmtSF + LowQualFinSF + HalfBath + KitchenAbvGr + 
    TotRmsAbvGrd + Fireplaces + WoodDeckSF + OpenPorchSF + EnclosedPorch + 
    X3SsnPorch + ScreenPorch + PoolArea + MoSold, data = newNumericasTrain)
summary(mejorModelo)
```

#### Validaci칩n del modelo

##### Significancia Global

\[ H_0: \beta\_1 = \beta\_2 = ... = \beta\_n = 0 \]

\[ H_1: \text{Alguno de los coeficientes es diferente de 0} \]

Dado que \$ \text{valor-p} \< 2 \times 10\^{-16} \< 0.05 \implies H_0 \$ se rechaza, por lo cual es razonable afirmar que el modelo tiene significancia global.

##### Significancia individual
De la tabla anterior tenemos que, con un nivel de significancia de 5%, las variables BsmtFinSF2, LowQualFinSF, OpenPorchSF, X3SsnPorch, ScreenPorch, PoolArea,  MoSold no poseen significancia individual. Por lo tanto, procedamos a crear un modelo sin estas variables.

##### Nuevo modelo
```{r nuevoModelo}
mdLnMtvS <- lm(SalePrice ~ MSSubClass + LotArea + OverallQual + BsmtFinSF1 + TotalBsmtSF + HalfBath + KitchenAbvGr + TotRmsAbvGrd + Fireplaces + WoodDeckSF + EnclosedPorch, data = newNumericasTrain)
summary(mdLnMtvS)
```
##### An치lisis de residuales
###### Normalidad
```{r normalidad}
qqnorm(mdLnMtvS$residuals)
qqline(mdLnMtvS$residuals)
```
Es discutible el hablar de normalidad utilizando la gr치fica anterior, pues en los datos del centro pareciera existir, pero los puntos de los extremos se alejan demasiado de la l칤nea de los 45춿. Por lo que se realizar치 una prueba de Lilliefors para determinar si existe dicha normalidad

$$ H_0: \text{Normalidad en los residuales} $$
$$ H_1: \text{No hay normalidad en los residuales} $$

```{r}
lillie.test(mdLnMtvS$residuals)
```

El test anterior nos brinda un $ \text{valor-p} = 2.2 \times 10^{-16} < \alpha = 0.05 \implies H_0 $ debe ser rechazada y, por lo tanto, no existe evidencia suficiente para afirmar que los residuales se comportan de forma normal.

###### Homocedasticidad
Utilizaremos la prueba de Breusch Pagan.
$$ H_0: \text{Homocedasticidad} $$
$$ H_1: \text{No homocedasticidad} $$
```{r homocedasticidad}
bptest(mdLnMtvS)
```
El test anterior devuelve un $ \text{valor-p} = 2.2 \times 10^{-16} < \alpha 0.05 \implies H_0 $ debe ser rechazada, por lo que no existe evidencia para afirmar homocedasticidad.

###### Independencia

```{r independenciaGrafica}
plot(mdLnMtvS$fitted.values, mdLnMtvS$residuals)
```
En la gr치fica se puede observar que los residuales siguen un patr칩n bien definido, lo cual es un claro indicador de la ausencia de independencia.

###### Independencia de los residuales
Utilizaremos la prueba de Durbin Watson, la cual mide la autocorrelaci칩n entre los residuales.

$$ H_0:  \text{Los residuales estan autocorrelacionados}$$
$$ H_1: \text{No existe autocorrelaci칩n en los residuales}$$


```{r independencia}
dwtest(mdLnMtvS)
```
El test anterior devuelve un $valor-p = 0.8921 > \alpha = 0.05 \implies H_0$ no puede ser rechazada, esto indica que los residuales est치n autocorrelacionados, por lo que podemos afirmar que los residuales no son independientes.

###### Valor esperado igual a 0

```{r valorEsperado}
t.test(mdLnMtvS$residuals)

```
$$ H_0: \mu_{residuales} = 0 $$
$$ H_1: \mu_{residuales} \neq 0 $$
Con un $valor-p = 1 > \alpha = 0.05 \implies H_0 $ no puede ser rechazada, por lo que es posible afirmar que la media de los residuales es igual a 0

###### Conclusi칩n
Debido a que el modelo no cumple con los supuestos, no se recomienda su uso para predecir el precio de las casas en Ames y Iowa.

##### Predicci칩n
```{r prediccion}
prediccion <- predict(mdLnMtvS, newdata = test)
mean((prediccion - test$SalePrice)^2)
```
Podemos ver que el error medio cuadrado es de 1303358790, lo cual confirma la conclusi칩n anterior que el modelo no es adecuado para la predicci칩n del precio de las casas.
